{"pageProps":{"post":{"attributes":{"description":""},"html":"<p>What should you do if you find you referring to the same query over and over again? We have several shortcuts to store frequently used functions in PostgreSQL. In the next chapter we&#39;ll talk about views which is one way to do it but we are going to talk about functions and procedures in this chapter. Let&#39;s learn about functions in this section and in the next section when you learn about procedures we will talk about the difference is between the two.</p>\n<p>A function is just like you expect from a programming lanugage. Given parameters, it will return an output of some variety.</p>\n<p>Let&#39;s say we&#39;re focusing our recipe site on recipes with few ingredients (for lazy people, like me.) Let&#39;s say we give users a way to filter recipes by how many ingredients are in the recipe.</p>\n<pre><code class=\"hljs language-sql\"><span class=\"hljs-keyword\">SELECT</span>\n  r.title\n<span class=\"hljs-keyword\">FROM</span>\n  recipe_ingredients ri\n\n<span class=\"hljs-keyword\">INNER</span> <span class=\"hljs-keyword\">JOIN</span>\n  recipes r\n<span class=\"hljs-keyword\">ON</span>\n  r.recipe_id <span class=\"hljs-operator\">=</span> ri.recipe_id\n\n<span class=\"hljs-keyword\">GROUP</span> <span class=\"hljs-keyword\">BY</span>\n  r.title\n<span class=\"hljs-keyword\">HAVING</span>\n  <span class=\"hljs-built_in\">COUNT</span>(r.title) <span class=\"hljs-keyword\">BETWEEN</span> <span class=\"hljs-number\">4</span> <span class=\"hljs-keyword\">AND</span> <span class=\"hljs-number\">6</span>;\n</code></pre>\n<p>This will give you all recipes that are have 4, 5, or 6 ingredients in them. Okay, let&#39;s saying this is a big focus of our website and we&#39;re going to repeat this everywhere, it would be annoying to copy and paste this everywhere. Wouldn&#39;t be cool if PostgreSQL would let us wrap this up into an easy to use function?</p>\n<p>Ask and you shall receive.</p>\n<pre><code class=\"hljs language-sql\"><span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">OR</span> REPLACE <span class=\"hljs-keyword\">FUNCTION</span>\n  get_recipes_with_ingredients(low <span class=\"hljs-type\">INT</span>, high <span class=\"hljs-type\">INT</span>)\n<span class=\"hljs-keyword\">RETURNS</span>\n  SETOF <span class=\"hljs-type\">VARCHAR</span>\n<span class=\"hljs-keyword\">LANGUAGE</span>\n  plpgsql\n<span class=\"hljs-keyword\">AS</span>\n$$\n<span class=\"hljs-keyword\">BEGIN</span>\n  <span class=\"hljs-keyword\">RETURN</span> QUERY <span class=\"hljs-keyword\">SELECT</span>\n    r.title\n  <span class=\"hljs-keyword\">FROM</span>\n    recipe_ingredients ri\n\n  <span class=\"hljs-keyword\">INNER</span> <span class=\"hljs-keyword\">JOIN</span>\n    recipes r\n  <span class=\"hljs-keyword\">ON</span>\n    r.recipe_id <span class=\"hljs-operator\">=</span> ri.recipe_id\n\n  <span class=\"hljs-keyword\">GROUP</span> <span class=\"hljs-keyword\">BY</span>\n    r.title\n  <span class=\"hljs-keyword\">HAVING</span>\n    <span class=\"hljs-built_in\">COUNT</span>(r.title) <span class=\"hljs-keyword\">between</span> low <span class=\"hljs-keyword\">and</span> high;\n<span class=\"hljs-keyword\">END</span>;\n$$;\n</code></pre>\n<blockquote>\n<p>You could accomplish this several ways. Functions is just an easy to do this.</p>\n</blockquote>\n<p>Now query it.</p>\n<pre><code class=\"hljs language-sql\"><span class=\"hljs-keyword\">SELECT</span> <span class=\"hljs-operator\">*</span> <span class=\"hljs-keyword\">FROM</span> get_recipes_with_ingredients(<span class=\"hljs-number\">2</span>, <span class=\"hljs-number\">3</span>);\n</code></pre>\n<p>Now we have a function that we can call from whenever we need to our more complicated query. This can come in very handy if your team has shared needs.</p>\n<p>Let&#39;s break down some features of it:</p>\n<ul>\n<li>You can just say CREATE or you can just say REPLACE. I added both so it wouldn&#39;t trip you up</li>\n<li><code>DROP FUNCTION get_recipes_with_ingredients(low int, high int)</code> will delete the function</li>\n<li>You do need to declare a return type, either in the function definiton like we did, or in the invocation</li>\n<li><code>$$</code> is called &quot;dollar quotes&quot;. You can actually use them instead of <code>&#39;</code> in your insertions if you&#39;re sick of writing <code>&#39;&#39;</code> for your single quotes and <code>\\\\</code> for your backslashes. It&#39;s just really ugly. Here we use them because we have a long quote and it would be very annoying to try and escape everything</li>\n<li>This language is called PL/pgSQL. It&#39;s a very SQL like language designed to be easy to write functions and procedures. PostgreSQL actually allows itself to be extended and you can use <a href=\"https://plv8.github.io/\">JavaScript</a>, <a href=\"https://www.postgresql.org/docs/current/plpython.html\">Python</a>, and other languages to write these as well</li>\n<li>Here we&#39;re just returning the result of a query. There&#39;s a myriad of more powerful things you can do with functions and fun sorts of aggregation. I&#39;ll leave that to you to explore. This is not a class on functions; it&#39;s a very deep topic</li>\n</ul>\n<p>A note from your potential future self or coworker: <em>do not go overboard</em>. This are powerful but they can also be weird to debug. Where do you store the code for these? How are you going to debug it when it has a bug in production? There are ways to handle these things but it&#39;s <em>different</em> than just handling it in your server&#39;s code. Use with caution.</p>\n","slug":"functions","title":"Functions","section":"Functions Triggers and Procedures","icon":"stairs","filePath":"/home/runner/work/complete-intro-to-sql/complete-intro-to-sql/lessons/07-functions-triggers-and-procedures/A-functions.md","nextSlug":"/lessons/functions-triggers-and-procedures/procedures","prevSlug":"/lessons/aggregation/having"}},"__N_SSG":true}