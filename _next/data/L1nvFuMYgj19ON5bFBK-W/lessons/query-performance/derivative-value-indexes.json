{"pageProps":{"post":{"attributes":{},"html":"<p>Let&#39;s say you have a view where you want to see the biggest different between revenue and budget (more-or-less profit but keep in mind it&#39;s all <a href=\"https://en.wikipedia.org/wiki/Hollywood_accounting\">Hollywood accounting</a> anyway).</p>\n<p>This is a derived value. It&#39;s the budget column subtracted from the revenue column. If you run this query as is it&#39;s really expensive.</p>\n<pre><code class=\"language-sql\">EXPLAIN ANALYZE SELECT\n  name, date, revenue, budget, COALESCE((revenue - budget), 0) AS profit\nFROM\n  movies\nORDER BY\n  profit DESC\nLIMIT 10;\n</code></pre>\n<p>What if this is a hot path for us? We don&#39;t want such a slow query for an important part of our app. We can make a index on a derived value and PostgreSQL will be smart enough to use it.</p>\n<pre><code class=\"language-sql\">CREATE INDEX idx_movies_profit ON movies (COALESCE((revenue - budget), 0));\n\nEXPLAIN ANALYZE SELECT\n  name, date, revenue, budget, COALESCE((revenue - budget), 0) AS profit\nFROM\n  movies\nORDER BY\n  profit DESC\nLIMIT 10;\n</code></pre>\n<p>The difference here is stark. For my computer it&#39;s <code>cost=7258.76..7259.91 </code> for the slow query and <code>cost=0.42..1.33</code> for the indexed query.</p>\n<h2 id=\"this-is-just-a-taste\">This is just a taste</h2>\n<p>I&#39;ve shown you just a taste of indexing. Optimizng queries is a whole profession unto itself and anything much more complicated than this I would probably consult a <a href=\"https://en.wikipedia.org/wiki/Database_administration\">DBA</a> or another expert to help me craft well.</p>\n<p>The key here is you typically want to use some sort of monitoring software to watch for slow queries that you&#39;re running frequently and then optimize for those. If you have a slow query that only gets run once a day then that&#39;s fine for that to be slow (usually, you also don&#39;t want to lock your whole database once a day either) or if you have a query that gets run a lot but PostgreSQL is already running it fast then you probably don&#39;t need an index either. You want indexes for frequently run queries that are running slow.</p>\n","slug":"derivative-value-indexes","title":"Derivative Value Indexes","section":"Query Performance","icon":"fire","filePath":"/home/runner/work/complete-intro-to-sql/complete-intro-to-sql/lessons/09-query-performance/F-derivative-value-indexes.md","nextSlug":"/lessons/views/basic-views","prevSlug":"/lessons/query-performance/partial-indexes"}},"__N_SSG":true}